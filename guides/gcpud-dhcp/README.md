# README

## DHCP server setup

### 1. Install DHCP Server
`sudo apt install isc-dhcp-server` 

### 2. Configure the DHCP Server
The main configuration file of ISC DHCP server is /etc/dhcp/dhcpd.conf

### 3. Installing omshell
Omapi/omshell is used to remotely configure a dhcp server, ie add leases to the lease file. The GCPUD provisioning process uses Omapi to configure the lease file. The DHCP server needs omshell installed before Omapi can be used, process as follows:
1. Install omshell a omapi client: 'sudo apt-get install isc-dhcp-common'
2. Verify omshell is installed: 'which omshell'
3. A Omapi key needs to be used to communicate between our microservices (just active-e-service) and the DHCP server using omshell. This key is different depending on whether it is the dev(stage and preprod) or production environments. You'll see an entry like the following in the /etc/dhcp/dhcpd.conf file: \
`
key tsig-key {
        algorithm hmac-md5;
        secret "cRslg24IB6zLPaLw8x5r7g==";
};\
omapi-key tsig-key;\
omapi-port 9991;
`
4. The key and port used in this conf file must match the key and port in the active-e-service.
5. You should never have to regenerate the key, but if you do, it can be generated by doing the following:
   * `sudo apt-get -y install bind9utils`
   * `tsig-keygen -a HMAC-MD5 omapi_key`
   * Copy and paste the output of that into your /etc/dhcp/dhcpd.conf file, and make sure to paste it in the active-e-service too

### 4. GCPUD dev DHCP Server
The dev (stage and preprod) server is dev.dhcp.gcpud.aex.blue (10.252.2.81).\
The /etc/dhcp/dhcpd.conf can be found in this folder, named **dev_dhcpd.conf**.

### 5. GCPUD production DHCP Servers
The production environment has two DHCP servers, dhcp.gcpud.aex.blue (10.253.2.81) and dhcp-b.gcpud.aex.blue (10.253.2.200).\
The /etc/dhcp/dhcpd.conf can be found in this folder, named **10_253_2_81_dhcpd.conf** and **10_253_2_200_dhcpd.conf**.

## Tips
* To restart the DHCP server: `sudo systemctl restart isc-dhcp-server.service`
* To get the server status: `sudo systemctl status isc-dhcp-server.service`
* To see whats wrong in the logs or to see which ONT is connecting to the server: `sudo journalctl -u isc-dhcp-server.service -f`
* dhcpd.leases file location: `cat /var/lib/dhcp/dhcpd.leases`
* dhcpd.conf file location: `cat /etc/dhcp/dhcpd.conf`
* Manually changing the leases file requires a DHCP server restart for the changes to take effect, but changing it via omshell does not